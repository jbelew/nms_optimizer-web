name: Crowdin Sync

on:
    push:
        branches:
            - main
    schedule:
        - cron: "0 0 * * *" # every day at midnight UTC

jobs:
    sync:
        runs-on: ubuntu-latest
        permissions:
            contents: write
            pull-requests: write

        steps:
            - name: Checkout
              uses: actions/checkout@v4

            - name: Install Crowdin CLI
              run: |
                  curl -LO https://github.com/crowdin/cli/releases/latest/download/crowdin-linux-64bit.tar.gz
                  tar -xzf crowdin-linux-64bit.tar.gz
                  sudo mv crowdin /usr/local/bin/

            - name: Ensure Crowdin branch exists
              env:
                  CROWDIN_PERSONAL_TOKEN: ${{ secrets.CROWDIN_PERSONAL_TOKEN }}
              run: |
                  crowdin branch add name main || echo "Branch already exists"

            - name: Crowdin Upload / Download
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
                  CROWDIN_PROJECT_ID: ${{ secrets.CROWDIN_PROJECT_ID }}
                  CROWDIN_PERSONAL_TOKEN: ${{ secrets.CROWDIN_PERSONAL_TOKEN }}
              run: |
                  # Upload sources
                  crowdin upload sources --project-id $CROWDIN_PROJECT_ID --token $CROWDIN_PERSONAL_TOKEN

                  # Download translations
                  crowdin download --project-id $CROWDIN_PROJECT_ID --token $CROWDIN_PERSONAL_TOKEN

            - name: Create / Update Crowdin PR
              uses: peter-evans/create-pull-request@v5
              with:
                  token: ${{ secrets.GITHUB_TOKEN }}
                  commit-message: "Update translations from Crowdin"
                  branch: crowdin-translations
                  base: main
                  title: "New Crowdin Translations"
                  body: "This pull request contains the latest translations from Crowdin."
                  labels: "translation"
