name: Test and Deploy to Heroku

on:
  workflow_run:
    workflows: ["Release"]
    types: [completed]
    branches: [main]

jobs:
  get_release_info:
    runs-on: ubuntu-latest
    outputs:
      conclusion: ${{ steps.get_workflow_info.outputs.conclusion }}
      app_version: ${{ steps.get_app_version.outputs.version }}
    steps:
      - name: Get workflow run conclusion
        id: get_workflow_info
        uses: actions/github-script@v7
        with:
          script: |
            const { data: workflowRun } = await github.rest.actions.getWorkflowRun({
              owner: context.repo.owner,
              repo: context.repo.repo,
              run_id: context.payload.workflow_run.id
            });
            const conclusion = workflowRun.conclusion;
            console.log(`Workflow run conclusion: ${conclusion}`);
            core.setOutput('conclusion', conclusion);

      - name: Checkout main branch to get package.json
        if: ${{ steps.get_workflow_info.outputs.conclusion == 'success' }}
        uses: actions/checkout@v4
        with:
          ref: main # Checkout main branch directly
          token: ${{ secrets.GITHUB_TOKEN }} # Use GITHUB_TOKEN for checkout
          fetch-depth: 0 # Fetch full history to ensure latest is available

      - name: Ensure latest main branch is fetched # Re-adding this step
        if: ${{ steps.get_workflow_info.outputs.conclusion == 'success' }}
        run: |
          git pull origin main
          git reset --hard origin/main

      - name: Get App Version from package.json
        id: get_app_version
        if: ${{ steps.get_workflow_info.outputs.conclusion == 'success' }}
        run: |
          VERSION=$(node -p "require('./package.json').version")
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "App Version from package.json: $VERSION"

  test:
    runs-on: ubuntu-latest
    needs: get_release_info
    if: ${{ needs.get_release_info.outputs.conclusion == 'success' }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: main # Checkout main branch directly
          token: ${{ secrets.GITHUB_TOKEN }} # Use GITHUB_TOKEN for checkout

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install dependencies
        run: npm install

      - name: Run vitest tests in CI mode
        run: npm run test:ci

      - name: Build application with semantic version
        run: VITE_APP_VERSION=${{ needs.get_release_info.outputs.app_version }} npm run build

  deploy:
    runs-on: ubuntu-latest
    needs: [get_release_info, test]
    if: ${{ needs.get_release_info.outputs.conclusion == 'success' && needs.test.result == 'success' }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: main # Checkout main branch directly
          token: ${{ secrets.GITHUB_TOKEN }} # Use GITHUB_TOKEN for checkout
          fetch-depth: 0 # Ensure full history is fetched

      - name: Ensure latest main branch is fetched for deploy
        run: |
          git pull origin main
          git reset --hard origin/main

      - name: Install Heroku CLI
        run: curl https://cli-assets.heroku.com/install.sh | sh

      - uses: akhileshns/heroku-deploy@v3.14.15
        with:
            heroku_api_key: ${{secrets.HEROKU_API_KEY}}
            heroku_app_name: "nms-optimizer-web"
            heroku_email: "john.belew@gmail.com"
            branch: main # Explicitly push the main branch

      - name: Set Heroku Config
        run: |
          # Set VITE_BUILD_VERSION to the GitHub Actions run number (build identifier)
          heroku config:set VITE_BUILD_VERSION=build-${{ github.run_number }} --app nms-optimizer-web
          # Set VITE_APP_VERSION to the semantic version from package.json
          heroku config:set VITE_APP_VERSION=${{ needs.get_release_info.outputs.app_version }} --app nms-optimizer-web