name: Deploy to Heroku

on:
    workflow_run:
        workflows: ["release.yml"]
        types: [completed]

concurrency:
    group: deploy-production
    cancel-in-progress: false

jobs:
    get_release_info:
        if: github.event.workflow_run.conclusion == 'success' && github.event.workflow_run.head_branch == 'main'
        runs-on: ubuntu-latest
        outputs:
            app_version: ${{ steps.get_app_version.outputs.version }}
        steps:
            - name: Checkout main branch to get package.json
              uses: actions/checkout@v6
              with:
                  ref: main # Checkout main branch directly
                  token: ${{ secrets.GITHUB_TOKEN }} # Use GITHUB_TOKEN for checkout
                  fetch-depth: 0 # Fetch full history to ensure latest is available

            - name: Get App Version from package.json
              id: get_app_version
              run: |
                  VERSION=$(node -p "require('./package.json').version")
                  echo "version=$VERSION" >> $GITHUB_OUTPUT
                  echo "App Version from package.json: $VERSION"

    deploy:
        runs-on: ubuntu-latest
        needs: [get_release_info]
        if: needs.get_release_info.result == 'success'
        steps:
            - name: Checkout code
              uses: actions/checkout@v6
              with:
                  ref: main # Checkout main branch directly
                  token: ${{ secrets.GITHUB_TOKEN }} # Use GITHUB_TOKEN for checkout
                  fetch-depth: 0 # Ensure full history is fetched

            - name: Set up Node.js
              uses: actions/setup-node@v6
              with:
                  node-version: "lts/*"
                  cache: 'npm'

            - name: Verify app version
              run: echo "Deploying app version ${{ needs.get_release_info.outputs.app_version }}"

            - name: Install Heroku CLI
              run: curl https://cli-assets.heroku.com/install.sh | sh

            - uses: akhileshns/heroku-deploy@v3.14.15
              with:
                  heroku_api_key: ${{secrets.HEROKU_API_KEY}}
                  heroku_app_name: "nms-optimizer-web"
                  heroku_email: ${{ secrets.HEROKU_EMAIL }}
                  branch: main # Explicitly push the main branch
              env:
                  HD_VITE_APP_VERSION: ${{ needs.get_release_info.outputs.app_version }}
                  HD_VITE_BUILD_VERSION: build-${{ github.run_number }}

            - name: Purge Cloudflare Cache
              if: success()
              run: |
                  RESPONSE=$(curl -s -X POST "https://api.cloudflare.com/client/v4/zones/${{ secrets.CLOUDFLARE_ZONE_ID }}/purge_cache" \
                  -H "Authorization: Bearer ${{ secrets.CLOUDFLARE_API_TOKEN }}" \
                  -H "Content-Type: application/json" \
                  --data '{"purge_everything":true}')
                  
                  if echo "$RESPONSE" | grep -q '"success":true'; then
                    echo "✅ Cloudflare cache purged successfully"
                  else
                    echo "❌ Failed to purge Cloudflare cache: $RESPONSE"
                    exit 1
                  fi
