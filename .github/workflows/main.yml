name: Test and Deploy to Heroku

on:
  workflow_run:
    workflows: ["Release"]
    types: [completed]
    branches: [main]

jobs:
  get_release_info:
    runs-on: ubuntu-latest
    outputs:
      conclusion: ${{ steps.get_workflow_info.outputs.conclusion }}
      app_version: ${{ steps.get_app_version.outputs.version }}
    steps:
      - name: Get workflow run conclusion
        id: get_workflow_info
        uses: actions/github-script@v8
        with:
          script: |
            const { data: workflowRun } = await github.rest.actions.getWorkflowRun({
              owner: context.repo.owner,
              repo: context.repo.repo,
              run_id: context.payload.workflow_run.id
            });
            const conclusion = workflowRun.conclusion;
            console.log(`Workflow run conclusion: ${conclusion}`);
            core.setOutput('conclusion', conclusion);

      - name: Checkout main branch to get package.json
        if: ${{ steps.get_workflow_info.outputs.conclusion == 'success' }}
        uses: actions/checkout@v4
        with:
          ref: main # Checkout main branch directly
          token: ${{ secrets.GITHUB_TOKEN }} # Use GITHUB_TOKEN for checkout
          fetch-depth: 0 # Fetch full history to ensure latest is available

      - name: Ensure latest main branch is fetched # Re-adding this step
        if: ${{ steps.get_workflow_info.outputs.conclusion == 'success' }}
        run: |
          git pull origin main
          git reset --hard origin/main

      - name: Get App Version from package.json
        id: get_app_version
        if: ${{ steps.get_workflow_info.outputs.conclusion == 'success' }}
        run: |
          VERSION=$(node -p "require('./package.json').version")
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "App Version from package.json: $VERSION"

  test:
    runs-on: ubuntu-latest
    needs: get_release_info
    if: ${{ needs.get_release_info.outputs.conclusion == 'success' }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: main # Checkout main branch directly
          token: ${{ secrets.GITHUB_TOKEN }} # Use GITHUB_TOKEN for checkout

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install dependencies
        run: npm install

      - name: Run pre-commit checks
        run: |
          npm run format:check
          npm run lint
          npm run lint:css
          npm run typecheck
          npm run test:ci
  deploy:
    runs-on: ubuntu-latest
    needs: [get_release_info, test]
    if: ${{ needs.get_release_info.outputs.conclusion == 'success' && needs.test.result == 'success' }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: main # Checkout main branch directly
          token: ${{ secrets.GITHUB_TOKEN }} # Use GITHUB_TOKEN for checkout
          fetch-depth: 0 # Ensure full history is fetched

      - name: Ensure latest main branch is fetched for deploy
        run: |
          git pull origin main
          git reset --hard origin/main
          echo "Current package.json version before Heroku deploy:"
          node -p "require('./package.json').version" # Log the version

      - name: Install Heroku CLI
        run: curl https://cli-assets.heroku.com/install.sh | sh

      - uses: akhileshns/heroku-deploy@v3.14.15
        with:
          heroku_api_key: ${{secrets.HEROKU_API_KEY}}
          heroku_app_name: "nms-optimizer-web"
          heroku_email: "john.belew@gmail.com"
          branch: main # Explicitly push the main branch
        env:
          HD_VITE_APP_VERSION: ${{ needs.get_release_info.outputs.app_version }}
          HD_VITE_BUILD_VERSION: build-${{ github.run_number }}