# Semver workflow
name: Release

on:
    push:
        branches:
            - main

jobs:
    release:
        name: Release
        runs-on: ubuntu-latest
        steps:
            - name: Checkout
              uses: actions/checkout@v6
              with:
                  fetch-depth: 0
            - name: Setup Node.js
              uses: actions/setup-node@v6
              with:
                  node-version: "lts/*"

            - name: Validate package.json and package-lock.json are in sync
              run: |
                  echo "Checking if package-lock.json is in sync with package.json..."
                  npm ci --dry-run --ignore-scripts --legacy-peer-deps

            - name: Install dependencies
              run: npm ci --legacy-peer-deps

            - name: Release
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
                  GIT_AUTHOR_NAME: "github-actions[bot]"
                  GIT_AUTHOR_EMAIL: "github-actions[bot]@users.noreply.github.com"
                  GIT_COMMITTER_NAME: "github-actions[bot]"
                  GIT_COMMITTER_EMAIL: "github-actions[bot]@users.noreply.github.com"
              run: npx semantic-release

            - name: Check if release was created
              id: check_release
              run: |
                  # Check if semantic-release created a version tag for the current commit
                  if git describe --exact-match --tags HEAD 2>/dev/null; then
                    echo "released=true" >> $GITHUB_OUTPUT
                    TAG=$(git describe --exact-match --tags HEAD)
                    echo "tag=${TAG}" >> $GITHUB_OUTPUT
                    echo "✅ Release created with tag: ${TAG}"
                  else
                    echo "released=false" >> $GITHUB_OUTPUT
                    echo "ℹ️ No release was created (no releasable commits)"
                  fi

            - name: Trigger Docker Build Workflow
              if: steps.check_release.outputs.released == 'true'
              uses: actions/github-script@v8
              with:
                  script: |
                      const tag = '${{ steps.check_release.outputs.tag }}';
                      console.log(`Triggering Docker build for tag: ${tag}`);

                      try {
                        await github.rest.actions.createWorkflowDispatch({
                          owner: context.repo.owner,
                          repo: context.repo.repo,
                          workflow_id: 'publish-images.yml',
                          ref: tag
                        });
                        console.log('✅ Docker build workflow triggered successfully');
                      } catch (error) {
                        console.error('❌ Failed to trigger Docker build:', error);
                        throw error;
                      }

            - name: Trigger Screenshot Update Workflow
              if: steps.check_release.outputs.released == 'true'
              uses: actions/github-script@v8
              with:
                  script: |
                      const tag = '${{ steps.check_release.outputs.tag }}';
                      console.log(`Triggering Screenshot Update for tag: ${tag}`);

                      try {
                        await github.rest.actions.createWorkflowDispatch({
                          owner: context.repo.owner,
                          repo: context.repo.repo,
                          workflow_id: 'update-screenshots.yml',
                          ref: tag
                        });
                        console.log('✅ Screenshot update workflow triggered successfully');
                      } catch (error) {
                        console.error('❌ Failed to trigger screenshot update:', error);
                        throw error;
                      }
